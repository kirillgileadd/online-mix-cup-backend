# üèÜ Tournament Bot ‚Äî Project Specification (README)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, —Å—É—â–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É Telegram-–±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏–∑ –Ω–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ —Ç—É—Ä–Ω–∏—Ä–∞.

---

# üìê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

Backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **API-—Å–µ—Ä–≤–µ—Ä –Ω–∞ Fastify**, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π:

- **Prisma** ‚Äî ORM
- **Fastify**
- **@fastify/jwt** ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è JWT
- **Zod** ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **Pino** ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **PostgreSQL** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Telegram Login Widget** ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Telegram

Backend –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á–µ—Ä–µ–∑ API –≤—ã–∑–æ–≤—ã –±–æ—Ç–∞ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤).
2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫ –Ω–∞ —É—á–∞—Å—Ç–∏–µ –≤ —Ç—É—Ä–Ω–∏—Ä–µ.
3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞–º–∏.
4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤.

---

# üß© –°—É—â–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î (–º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Prisma + SQLite/Postgres).

---

## **User**

–≠—Ç–æ —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –±–æ—Ç—É. –û–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç—É—Ä–Ω–∏—Ä–∞.

### –ü–æ–ª—è:

- `id`: uuid (PK)
- `telegramId`: string (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `username`: string | null
- `createdAt`: datetime

### –ß—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç:

- –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞—Ö
- –∑–∞—è–≤–∫–∏ –∏ —É—á–∞—Å—Ç–∏–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –µ–≥–æ `id`

---

## **Tournament**

–°–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ç—É—Ä–Ω–∏—Ä–µ.

### –ü–æ–ª—è:

- `id`: uuid (PK)
- `name`: string
- `status`: enum ‚Äî `draft`, `collecting`, `running`, `finished`
- `createdAt`: datetime

### –ß—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç:

- —Ç—É—Ä–Ω–∏—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∑–∞—Ä–∞–Ω–µ–µ
- —Å–±–æ—Ä –∑–∞—è–≤–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∫–ª—é—á—ë–Ω/–≤—ã–∫–ª—é—á–µ–Ω

---

## **Application**

–ó–∞—è–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —É—á–∞—Å—Ç–∏–µ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Ç—É—Ä–Ω–∏—Ä–µ.

### –ü–æ–ª—è:

- `id`: uuid (PK)
- `userId`: FK ‚Üí User.id
- `tournamentId`: FK ‚Üí Tournament.id
- `mmr`: number
- `gameRoles`: string
- `status`: enum ‚Äî `pending`, `approved`, `rejected`
- `createdAt`: datetime

### –ß—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç:

- –æ–¥–∏–Ω user –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞—è–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ä–∞–∑–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã)
- –∑–∞—è–≤–∫–∞ ‚â† –∏–≥—Ä–æ–∫ ‚Üí —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ —É—á–∞—Å—Ç–∏–µ
- –∑–∞—è–≤–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é

---

## **Player**

–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞.

### –ü–æ–ª—è:

- `id`: uuid (PK)
- `userId`: FK ‚Üí User.id
- `tournamentId`: FK ‚Üí Tournament.id
- `seed`: int | null ‚Äî –ø–æ—Å–µ–≤
- `score`: int | null ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `status`: enum ‚Äî `active`, `eliminated`
- `createdAt`: datetime

### –ß—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç:

- —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –¢–û–õ–¨–ö–û –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç—É—Ä–Ω–∏—Ä—É
- –æ–¥–∏–Ω User ‚Üí –º–Ω–æ–≥–æ Player (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—ã–π —Ç—É—Ä–Ω–∏—Ä)

---

## **Role**

–†–æ–ª—å, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∞—è –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –ü–æ–ª—è:

- `id`: uuid (PK)
- `name`: string (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `description`: string \| null
- `createdAt`: datetime

### –ß—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç:

- –Ω–∞–±–æ—Ä –ø—Ä–∞–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `admin`, `moderator`, `player`)
- –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –º–Ω–æ–∂–µ—Å—Ç–≤—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## **UserRole**

–°–≤—è–∑—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–µ–∂–¥—É User –∏ Role.

### –ü–æ–ª—è:

- `userId`: FK ‚Üí User.id
- `roleId`: FK ‚Üí Role.id
- `assignedAt`: datetime

### –ß—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç:

- –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–æ–ª–µ–π
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ JWT –∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–∞

---

## **RefreshToken**

–°–æ—Ö—Ä–∞–Ω—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ access —Ç–æ–∫–µ–Ω–æ–≤.

### –ü–æ–ª—è:

- `id`: uuid (PK)
- `userId`: FK ‚Üí User.id
- `token`: string (—Ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π refresh)
- `expiresAt`: datetime
- `createdAt`: datetime

### –ß—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç:

- –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–∑—ã–≤–∞—Ç—å refresh-—Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ logout
- —Ö—Ä–∞–Ω–∏—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏—è

---

# üî• –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–æ–≥–æ, –∫–∞–∫ –±–æ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å.

---

## 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É –≤–ø–µ—Ä–≤—ã–µ ‚Üí —Å–æ–∑–¥–∞—ë–º User

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –æ—Ç –Ω–æ–≤–æ–≥–æ Telegram ID:

```

---

# üê≥ Docker Compose

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `docker-compose.yml`:

1. –ü–æ–¥–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –±–∞–∑–æ–π:
```

docker compose up -d db

```
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `DATABASE_URL`, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```

DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tournament_bot"

```
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```

npm run prisma:migrate

```
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å API —Å–µ—Ä–≤–µ—Ä:
```

npm run dev

```

–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ volume `postgres_data`, –∞ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî `postgres / postgres`.
if (!user) createUser();
```

–°–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

---

## 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å" ‚Üí —Å–æ–∑–¥–∞—ë–º Application

–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ —Ö–æ—á–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ç—É—Ä–Ω–∏—Ä–µ:

```
createApplication({
  userId,
  tournamentId,
  status: "pending"
});
```

- User —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç—É—Ä–Ω–∏—Ä–∞.
- Application —Å–æ–∑–¥–∞—ë—Ç—Å—è –ö–ê–ñ–î–´–ô –†–ê–ó, –∫–æ–≥–¥–∞ –ø–æ–¥–∞—ë—Ç—Å—è –∑–∞—è–≤–∫–∞.

---

## 3. –ê–¥–º–∏–Ω –æ–¥–æ–±—Ä—è–µ—Ç –∑–∞—è–≤–∫–∏ ‚Üí —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `approved`

```
updateApplicationStatus(id, "approved")
```

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–µ—â—ë –Ω–µ Player**.

---

## 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ —Ç—É—Ä–Ω–∏—Ä–∞ ‚Üí —Å–æ–∑–¥–∞—é—Ç—Å—è Players

–ö–æ–≥–¥–∞ –∞–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä" –∏–ª–∏ –Ω–∞—Å—Ç—É–ø–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:

```
for each approved application:
    createPlayer({
        userId: application.userId,
        tournamentId: application.tournamentId
    })
```

–í–æ—Ç —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –∏ —è–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ—Ö–æ–¥–æ–º:
**Application ‚Üí Player**

---

# üîÑ –ö–æ—Ä–æ—Ç–∫–∞—è —Å—Ö–µ–º–∞ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

```
User –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ Telegram‚Äë–±–æ—Ç–∞ ‚Üí
    Backend –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí
        –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ User –ø–æ telegramId
            –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí create User

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è User ‚Üí
    create Application (pending)

–ê–¥–º–∏–Ω —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞—è–≤–∫—É ‚Üí
    Application.status = approved

–°—Ç–∞—Ä—Ç —Ç—É—Ä–Ω–∏—Ä–∞ ‚Üí
    –°–æ–∑–¥–∞—ë–º Player –¥–ª—è –∫–∞–∂–¥–æ–π –æ–¥–æ–±—Ä–µ–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏
```

–í API –∑–∞ —ç—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –º–µ—Ç–æ–¥ `UserRegistrationService.registerForTournament`, –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–æ `POST /users/register`: –æ–Ω –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —à–∞–≥–∏ `createUser` –∏ `createApplication`, —á—Ç–æ–±—ã –±–æ—Ç –º–æ–≥ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Ç—É—Ä–Ω–∏—Ä–∞.

---

# üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram Login Widget

1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç [Telegram Login Widget](https://core.telegram.org/widgets/login) –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç –Ω–µ–≥–æ –ø–æ–ª—è `id`, `username`, `auth_date`, `hash`, –∞ —Ç–∞–∫–∂–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.
2. –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ `POST /auth/telegram/login`.
3. Backend –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç `data-check-string`, –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ HMAC-SHA256 –∫–ª—é—á–æ–º `SHA256(bot_token)` –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å `hash`, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Telegram¬†Login Widget.
4. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è (–∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è), backend –≤—ã–¥–∞—ë—Ç `accessToken` (—Å –º–∞—Å—Å–∏–≤–æ–º —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `refreshToken` –≤ httpOnly cookie (refresh —Ç–∞–∫–∂–µ —Ö—ç—à–∏—Ä—É–µ—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `RefreshToken`). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª—å `player`.
5. `POST /auth/refresh` —á–∏—Ç–∞–µ—Ç refresh –∏–∑ cookie, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π `accessToken` –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç cookie; `POST /auth/logout` –æ—Ç–∑—ã–≤–∞–µ—Ç –≤—Å–µ refresh-—Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—á–∏—â–∞–µ—Ç cookie.

–î–ª—è –ø–æ–¥–ø–∏—Å–∏ –Ω—É–∂–µ–Ω `TELEGRAM_BOT_TOKEN`, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –¥–æ–º–µ–Ω—É —á–µ—Ä–µ–∑ `/setdomain`. –ü—Ä–æ–≤–µ—Ä–∫—É —Å–≤–µ–∂–µ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ –ø–æ–ª—é `auth_date` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –æ–∫–Ω–æ ‚Äî 5 –º–∏–Ω—É—Ç).

---

# üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- **Backend:** Fastify
- **ORM:** Prisma
- **Database:** PostgreSQL
- **Auth:** fastify/jwt
- **Validation:** Zod
- **Logging:** Pino
- **Telegram Bot Token:** `TELEGRAM_BOT_TOKEN` (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö Telegram Login Widget)

Backend –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–æ–¥—É–ª–∏ / —Å–µ—Ä–≤–∏—Å—ã:

- UserService (—Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
- ApplicationService (–∑–∞—è–≤–∫–∏)
- TournamentService (—Ç—É—Ä–Ω–∏—Ä—ã)
- PlayerService (–∏–≥—Ä–æ–∫–∏)
- RoleService (—Ä–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)

API –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è Telegram-–±–æ—Ç–æ–º, –Ω–æ –ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ.

---

# üß± –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### **User**

- `getOrCreateUser(telegramId)`
- `findUserByTelegramId()`
- `updateUser()`
- `deleteUser()`
- `registerUserForTournament(telegramId, tournamentId, mmr, gameRoles)`

### **Application**

- `createApplication(userId, tournamentId)`
- `approveApplication()`
- `rejectApplication()`
- `listPendingApplications()`

### **Tournament**

- `createTournament()`
- `startTournament()`

### **Player**

- `createPlayersFromApprovedApplications()`

### **Role**

- `createRole(name, description?)`
- `listRoles()`
- `assignRoleToUser(userId, role)`
- `removeRoleFromUser(userId, role)`
- `getUserRoles(userId)`

---

# üåê REST API (User)

| –ú–µ—Ç–æ–¥    | –ü—É—Ç—å                          | –û–ø–∏—Å–∞–Ω–∏–µ                                                |
| -------- | ----------------------------- | ------------------------------------------------------- |
| `GET`    | `/users`                      | –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π                                    |
| `POST`   | `/users`                      | –°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `telegramId`       |
| `GET`    | `/users/id/:id`               | –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ UUID                           |
| `GET`    | `/users/telegram/:telegramId` | –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegramId                     |
| `PATCH`  | `/users/:id`                  | –û–±–Ω–æ–≤–∏—Ç—å username                                       |
| `DELETE` | `/users/:id`                  | –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                                    |
| `POST`   | `/users/register`             | –°–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–¥–∞—ë—Ç –∑–∞—è–≤–∫—É –≤ —Ç—É—Ä–Ω–∏—Ä |

---

# üåê REST API (Auth)

| –ú–µ—Ç–æ–¥  | –ü—É—Ç—å                   | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                                     |
| ------ | ---------------------- | ------------------------------------------------------------------------------------------------------------ |
| `POST` | `/auth/telegram/login` | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram Login Widget, –≤—ã–¥–∞—á–∞ access —Ç–æ–∫–µ–Ω–∞ (—Å —Ä–æ–ª—è–º–∏) + —É—Å—Ç–∞–Ω–æ–≤–∫–∞ httpOnly refresh cookie |
| `POST` | `/auth/refresh`        | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞ –ø–æ refresh cookie                                                                   |
| `POST` | `/auth/logout`         | –û—Ç–∑—ã–≤ –≤—Å–µ—Ö refresh —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç—Ä–µ–±—É–µ—Ç—Å—è Bearer token)                                             |

---

# üåê REST API (Roles)

| –ú–µ—Ç–æ–¥  | –ü—É—Ç—å            | –û–ø–∏—Å–∞–Ω–∏–µ                                | –¢—Ä–µ–±—É–µ—Ç —Ä–æ–ª—å         |
| ------ | --------------- | --------------------------------------- | -------------------- |
| `GET`  | `/roles`        | –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | –õ—é–±–∞—è (–Ω—É–∂–µ–Ω Bearer) |
| `POST` | `/roles`        | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–æ–ª—å                      | `admin`              |
| `POST` | `/roles/assign` | –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é             | `admin`              |
| `POST` | `/roles/revoke` | –û—Ç–æ–∑–≤–∞—Ç—å —Ä–æ–ª—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è            | `admin`              |

---

# üéØ –¶–µ–ª—å —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞:

- –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ø–æ–∑–≤–æ–ª—è—Ç—å –æ–¥–Ω–æ–º—É —á–µ–ª–æ–≤–µ–∫—É –ø–æ–¥–∞—Ç—å—Å—è –≤ –º–Ω–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–æ–≤
- —á—ë—Ç–∫–æ —Ä–∞–∑–¥–µ–ª—è—Ç—å User / Application / Player
- —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä —Ç–æ–ª—å–∫–æ –∏–∑ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
- –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—É—é –ª–æ–≥–∏–∫—É

```

```
